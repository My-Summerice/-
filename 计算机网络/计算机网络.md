# 计算机网络

[toc]

## 1.传输层协议

### 1.1 TCP协议

**概念**：传输层协议，提供 **Host-To-Host** 数据的**可靠传输**，支持**全双工**，是一个**连接**导向的协议。

- Host-To-Host（主机到主机）：为应用提供应用间通信的能力。
- 连接（Connection）：通信双方的一个约定，目标是让两个在通信的程序之间产生一个默契，保证两个程序都在线且尽快地响应对方的请求。

- 单/双工问题：
  
   问题名称 | 概念                                                         | 需要几条线路 
   -------- | ------------------------------------------------------------ | ------------ 
   单工     | 在任何一个时刻，如果数据只能单向发送                         | 1条          
   半双工   | 在某个时刻数据可以向一个方向传输，也可以反方向传输，但是交替进行 | 1条          
   全双工   | 在任何时刻，数据都可以双向收发                               | 至少2条      
  
  **线路，是一个抽象的概念，你可以并发的处理信号，达到模拟双工的目的。**

- 可靠性（数据保证无损传输）：
	- 如果发送方按照顺序发送，然后数据无序地在网络间传递，就必须有一种算法在接收方将数据恢复原有的顺序。
	- 如果发送方同时要把消息发送给多个接收方这种情况叫**多播**，可靠性要求每个接收方都无损地收到相同的副本。

#### 1.1.1 TCP协议的基本操作

- 如果一个 Host 主动向另一个 Host 发起连接，称为 SYN（Synchroniation），请求同步。
- 如果一个 Host 主动断开请求，称为 FIN（Finish），请求完成。
- 如果一个 Host 给另一个 Host 发送数据，称为 PSH（Push），数据推送。

以上三种情况接收方收到数据后，都需要给发送方返回一个 ACK 响应（保持可靠性）。

![image-20220902213740840](/home/summerice/.config/Typora/typora-user-images/image-20220902213740840.png)

为TCP协议增加协议头，在协议头中取多个位（bit），其中SYN、ACK、PSH都各占有一个位。

![image-20220908145840447](/home/summerice/.config/Typora/typora-user-images/image-20220908145840447.png)

#### 1.1.2 TCP的封包格式

​		TCP协议会将数据拆分成**不超过缓冲区大小**的一个个部分，这样的每一个部分叫做**TCP段**。

- **拆包：**在数据太大时，将数据拆分成多个TCP段传输。
- **粘包：**在数据太小时，将多个数据合成一个TCP段发送。

#### 1.1.3 TCP段（TCP Segment）

![image-20220908152024561](/home/summerice/.config/Typora/typora-user-images/image-20220908152024561.png)

1. Source Port 和 Destination Port 描述的是发送端口号和目标端口号，代表发送数据的应用程序和接收数据的应用程序。

2. Sequence Number 和 Acknowledgment Number 是保证可靠性的两个关键。

3. Dataoffset 是一个偏移量，

	原因：TCP Header 部分的长度是可变的，需要一个数值来描述**数据**从哪个字节开始。

4. Reserved 是很多协议设计会保留的一个区域，用于日后扩展能力。

5. URG/ACK/PSH/RST/SYN/FIN 是几个标志位，用于描述 TCP 段的行为。

	- URG 代表一个紧急数据，例如 ctrl+c 终止一个程序运行。
	- ACK 代表响应。
	- PSH 代表数据推送，表示当前 TCP 段是在传输数据。
	- RST 代表重新连接，如果收到该位时，通常发生了某些错误。
	- SYN 代表同步请求，申请握手。
	- FIN 代表终止请求，挥手。

6. Window 也是TCP保证稳定性并进行流量控制的工具。

7. Checksum 是校验和，用于校验 TCP 段有没有损坏。

8. Urgent Pointer 指向最后一个紧急数据的序号（Sequence Number）。

	因为紧急数据可能会被分为好几个 TCP 段传输，所以需要设置此指针来告诉接收方到底有多少个 TCP 段的紧急数据。

9. Options 中存储了一些可选字段 MSS（Maxiumun Segment Size）。

10. Padding 存在的意义是因为 Options 的长度不固定，需要 Padding 进行对齐。

##### 1.1.3.1 Sequence Number 和 Acknowledgement Number

​	稳定性要求数据是无损地传输（拆包获得数据，又要恢复到原来的样子），在错综复杂的网络间传输，即使可以确保有序地发出，但无法保证能有序地接收到数据，所以发出的每一个 TCP 段都需要有序号——Sequence Number（Seq）。

- 发送数据的时候，为每一个 TCP 段分配一个自增的 Sequence Number。
- 接收数据的时候，可以通过 Seq 为乱序的 TCP 段进行排序。

然而，上述设计会产生一个新的问题：

​	接收方回复发送方，也需要 Seq （比如两人聊天需要确保两个人的聊天顺序），而网络中的两个终端，去同步一个自增的序号是非常困难的（因为时间无法做到完全同步，也没有公共的存储空间）。

##### 1.1.3.2 MSS（Maxiumun Segment Size）

- MSS 是**面试**经常会问到的一个 TCP Header 中的可选项（Options）
- 该可选项控制 TCP 段的大小，它是一个协商字段（Negotiate）

（待补充）。。。



问题： **TCP 协议是如何恢复数据的顺序的，TCP 拆包和粘包的作用是什么？**

答：TCP 拆包的作用：将任务拆分处理，降低整体任务出错的概率，以及减小底层网络处理的压力，拆包过程需要保证数据经过网络的传输，又能恢复到原始的顺序。

TCP 利用（发送字节数、接收字节数）的唯一性来确定封包之间的顺序关系。

TCP 粘包的作用：为了防止数据量过小，导致大量的传输，而将多个 TCP 段合并成一个发送。

#### 1.1.4 滑动窗口算法



问题：**滑动窗口和流速控制是怎么回事？**

答：滑动窗口是 TCP 协议控制可靠性的核心，发送方将数据拆包，变成多个分组（即 TCP 段）。然后将数据放入一个拥有滑动窗口的数组，依次发出，仍然遵循先进先出（FIFO）的顺序，但是窗口中的数据会一次性发送。窗口中序号最小的分组如果收到 ACK，窗口就会发生滑动，如果最小序号的分组长时间没有收到 ACK，就会触发整个窗口的数据重新传送。（窗口的大小由双方协商决定）

### 1.2 UDP协议

